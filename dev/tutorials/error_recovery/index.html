<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Minimum latency error recovery ¬∑ AllocCheck Documentation</title><meta name="title" content="Minimum latency error recovery ¬∑ AllocCheck Documentation"/><meta property="og:title" content="Minimum latency error recovery ¬∑ AllocCheck Documentation"/><meta property="twitter:title" content="Minimum latency error recovery ¬∑ AllocCheck Documentation"/><meta name="description" content="Documentation for AllocCheck Documentation."/><meta property="og:description" content="Documentation for AllocCheck Documentation."/><meta property="twitter:description" content="Documentation for AllocCheck Documentation."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">AllocCheck Documentation</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../optional_debugging_and_logging/">Optional debugging and logging</a></li><li><a class="tocitem" href="../hot_loop/">Hot loops</a></li><li class="is-active"><a class="tocitem" href>Minimum latency error recovery</a></li></ul></li><li><a class="tocitem" href="../../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Minimum latency error recovery</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Minimum latency error recovery</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaComputing/AllocCheck.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands">ÔÇõ</span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaComputing/AllocCheck.jl/blob/main/docs/src/tutorials/error_recovery.md" title="Edit source on GitHub"><span class="docs-icon fa-solid">ÔÅÑ</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Guaranteed-Error-Recovery"><a class="docs-heading-anchor" href="#Guaranteed-Error-Recovery">Guaranteed Error Recovery</a><a id="Guaranteed-Error-Recovery-1"></a><a class="docs-heading-anchor-permalink" href="#Guaranteed-Error-Recovery" title="Permalink"></a></h1><p>Safety-critical real-time systems are often required to have performance critical error-recovery logic. While errors are not supposed to occur, they sometimes do anyways üò¶, and when they do, we may want to make sure that the recovery logic runs with minimum latency.</p><p>In the following example, we are executing a loop that may throw an error. By default <a href="../../api/#AllocCheck.check_allocs"><code>check_allocs</code></a> allows allocations on the error path, i.e., allocations that occur as a consequence of an exception being thrown. This can cause the garbage collector to be invoked by the allocation, and introduce an unbounded latency before we execute the error recovery logic.</p><p>To guard ourselves against this, we may follow these steps</p><ol><li>Prove that the function does not allocate memory except for on exception paths.</li><li>Since we have proved that we are not allocating memory, we may disable the garbage collector. This prevents it from running before the error recovery logic.</li><li>To make sure that the garbage collector is re-enabled after an error has been recovered from, we re-enable it in a <code>finally</code> block.</li></ol><pre><code class="language-julia hljs">function treading_lightly()
    a = 0.0
    GC.enable(false) # Turn off the GC before entering the loop
    try
        for i = 10:-1:-1
            a += sqrt(i) # This throws an error for negative values of i
        end
    catch
        exit_gracefully() # This function is supposed to run with minimum latency
    finally
        GC.enable(true) # Always turn the GC back on before exiting the function
    end
    a
end
exit_gracefully() = println(&quot;Calling mother&quot;)

using AllocCheck, Test
allocs = check_allocs(treading_lightly, ()) # Check that it&#39;s safe to proceed</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">AllocCheck.AllocationSite[]</code></pre><pre><code class="language-julia hljs">@test isempty(allocs)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr32"><span class="sgr1">Test Passed</span></span></code></pre><p><a href="../../api/#AllocCheck.check_allocs"><code>check_allocs</code></a> returned zero allocations. If we invoke <a href="../../api/#AllocCheck.check_allocs"><code>check_allocs</code></a> with the flag <code>ignore_throw = false</code>, we will see that the function may allocate memory on the error path:</p><pre><code class="language-julia hljs">allocs = check_allocs(treading_lightly, (); ignore_throw = false)
length(allocs)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">6</code></pre><p>Finally, we test that the function is producing the expected result:</p><pre><code class="language-julia hljs">val = treading_lightly()</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr32"><span class="sgr1">Test Passed</span></span></code></pre><p>In this example, we accepted an allocation on the exception path with the motivation that it occurred once only, after which the program was terminated. Implicit in this approach is an assumption that the exception path does not allocate too much memory to execute the error recovery logic before the garbage collector is turned back on. We should thus convince ourselves that this assumption is valid, e.g., by means of testing:</p><pre><code class="language-julia hljs">treading_lightly() # Warm start
allocated_memory = @allocated treading_lightly() # A call that triggers the exception path
# @test allocated_memory &lt; 1e4</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">205440</code></pre><p>The allocations sites reported with the flag <code>ignore_throw = false</code> may be used as a guide as to what to test.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../hot_loop/">¬´ Hot loops</a><a class="docs-footer-nextpage" href="../../api/">API ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.2 on <span class="colophon-date" title="Friday 17 November 2023 17:37">Friday 17 November 2023</span>. Using Julia version 1.10.0-rc1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
